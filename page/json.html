<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="Description">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>JSON</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="/assets/bootstrap/bootstrap.min.css" />
    <script src="/assets/jsoneditor/jsoneditor9.8.js"></script>
    <link href="/assets/jsoneditor/jsoneditor9.8.css" rel="stylesheet" />
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/filereader.js"></script>
    <script src="/assets/js/jquery.js"></script>
    <script src="/assets/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="/assets/bootstrap/bootbox.js"></script>

<body>
    <div class="row justify-content-start" style="margin-bottom: 10px;">
        <div class="col-1">
            <button class="btn btn-primary" id="choose">选择</button>
        </div>
        <div class="col-4">
            <input type="file" id="loadDocument" value="Load" class="form-control" />
        </div>
    </div>
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasExampleLabel">JSON数据</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="list-group" id="list-group-id">
            </ul>
        </div>
    </div>
    <div id="jsoneditor" style="width: 100%; height: calc(100vh - 100px);"></div>
    <div style="position:fixed; bottom: 50%; right: 2%; z-index: 10000;">
        <button type="button" id="save2" class="btn btn-primary">
            <span class="glyphicon glyphicon-send" aria-hidden="true"></span>
            保存
        </button>
    </div>
    <script>
        const container = document.getElementById("jsoneditor")
        function getInitJSON() {
            try {
                let value = localStorage.getItem("json-editor") || '{}'
                return JSON.parse(value)
            } catch (e) {
                return {}
            }
        }
        const options = {
            "mode": "code",
            "search": true,
            "indentation": 4,
            "onChangeText": (json) => {
                try {
                    JSON.parse(json)
                    localStorage.setItem("json-editor", json)
                } catch (e) {

                }
            }
        }
        const editor = new JSONEditor(container, options, getInitJSON())
        const updatedJson = editor.get()
        const canvas = new bootstrap.Offcanvas('#offcanvasExample')
        let currentName = ""
        document.getElementById("save2").addEventListener('click', () => {
            if(currentName.length === 0) {
                bootbox.prompt("请输入名称", (fname) => {
                    if (fname == null || fname == '') {
                        return true
                    }
                    localStorage.setItem("JSON-" + fname, JSON.stringify(editor.get()))
                })
            } else {
                localStorage.setItem("JSON-" + currentName, JSON.stringify(editor.get()))
            }
           
        })
        document.getElementById("choose").addEventListener("click", () => {
            let list = []
            for (var key in localStorage) {
                if (key.indexOf("JSON-") === 0) {
                    let name = key.replace("JSON-", "")
                    list.push(name)
                }
            }
            
            canvas.show()
            let eleList = []
            for(var i in list) {
                eleList.push('<a href="javascript:;" class="list-group-item list-group-item-action">' + list[i]+'</a>')
            }
            document.getElementById("list-group-id").innerHTML = eleList.join("")
            console.log(list)
        })
        document.getElementById("list-group-id").addEventListener("click", (el) => {
            canvas.hide()
            let content = localStorage.getItem('JSON-' + el.target.textContent)
            try {
                let data = JSON.parse(content)
                editor.set(data)
            } catch (e) {
            }
            canvas.hide()
        })
        // Load a JSON document
        FileReaderJS.setupInput(document.getElementById('loadDocument'), {
            readAsDefault: 'Text',
            on: {
                load: function (event, file) {
                    editor.setText(event.target.result)
                }
            }
        })


    </script>
</body>
<style type="text/css">
    body {
        padding: 20px 7%;
        font-size: 15px;
    }
</style>

</html>